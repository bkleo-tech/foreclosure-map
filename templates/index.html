<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foreclosure Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .filters {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .filters input, .filters select {
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="filters">
        <input type="text" id="searchLocation" placeholder="Search location...">
        <select id="filterType">
            <option value="">All Types</option>
            <option value="Residential">Residential</option>
            <option value="Commercial">Commercial</option>
            <option value="Industrial">Industrial</option>
        </select>
        <input type="number" id="minPrice" placeholder="Min Price">
        <input type="number" id="maxPrice" placeholder="Max Price">
        <button onclick="updateMarkers()">Apply Filters</button>
    </div>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([14.5995, 120.9842], 11); // Manila coordinates
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let allProperties = [];

        // Fetch properties from API
        fetch('/api/properties')
            .then(response => response.json())
            .then(properties => {
                console.log('Received properties:', properties);
                allProperties = properties;
                updateMarkers();
            })
            .catch(error => {
                console.error('Error fetching properties:', error);
            });

        function updateMarkers() {
            console.log('Updating markers...');
            // Remove old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Get filter values
            const searchLocation = document.getElementById('searchLocation').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            // Filter properties
            const filtered = allProperties.filter(p => {
                const matchesLocation = p.address.toLowerCase().includes(searchLocation);
                const matchesType = !filterType || p.type === filterType;
                const price = parseFloat(p.price) || 0;
                const matchesPrice = price >= minPrice && price <= maxPrice;
                return matchesLocation && matchesType && matchesPrice;
            });

            console.log('Filtered properties:', filtered);

            // Add markers using real coordinates
            filtered.forEach((p, i) => {
                if (p.latitude && p.longitude) {
                    console.log('Adding marker for property:', p);
                    const lat = parseFloat(p.latitude);
                    const lng = parseFloat(p.longitude);
                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.on('click', () => showPropertyModal(p));
                    marker.bindPopup(`<b>${p.type}</b><br>${p.address}`);
                    markers.push(marker);
                } else {
                    console.log('Property missing coordinates:', p);
                }
            });
        }

        function showPropertyModal(property) {
            // Create a more detailed popup
            const popupContent = `
                <div style="max-width: 300px;">
                    <h3>${property.type}</h3>
                    <p><strong>Address:</strong> ${property.address}</p>
                    <p><strong>Price:</strong> ₱${property.price.toLocaleString()}</p>
                    <p><strong>Lot Area:</strong> ${property.lot_area} sqm</p>
                    <p><strong>Floor Area:</strong> ${property.floor_area} sqm</p>
                    <p><strong>Class:</strong> ${property.class}</p>
                    <p><strong>Sales Officer:</strong> ${property.sales_officer}</p>
                    ${property.image ? `<img src="${property.image}" style="max-width: 100%;">` : ''}
                </div>
            `;
            L.popup()
                .setLatLng([property.latitude, property.longitude])
                .setContent(popupContent)
                .openOn(map);
        }
    </script>
</body>
</html> 